<template>
	<div class="col-md-12 margin-bottom-10">
		<button class="btn btn-default btn-icon-text waves-effect" btn="eventSaveRuleFilters">
			<i class="zmdi zmdi-check"></i> Save
		</button>
	</div>
    <div class="col-md-12">
        <div class='matrix-result-preview'></div>
    </div>
    <script async>
    var oFilter = function() {
        return {
            _id: {
                "$oid": ""
            },
            author: "",
            filterName: "",
            guid: "",
            lastEditUser: "",
            lastUpdateTime: {
                $date: ""
            },
            objects: []
        }
    };

    var oRule = function() {
        return {
            "active": true,
            "filterRef": [],
            "ruleName": "",
            "ruleCategory": {
                "display": "",
                "value": ""
            },
            "ruleType": {
                "display": "",
                "value": ""
            },
            "action": {
                "display": "",
                "value": ""
            },
            "defaultCriticalRatio": "",
            "minTargetInv": "",
            "criticalRatio": "",
            "horizonAdjust": ""
        }
    };

    var oScenario = function() {
        return {
            "_id": {
                "$oid": ""
            },
            "guid": "",
            "lastEditUser": "",
            "lastUpdateTime": {
                "$date": ""
            },
            "author": "",
            "scenarioName": "",
            "scenarioDesc": "",
            "production": false,
            "rules": []
        }
    };

    var MatrixEditor = (function() {
        var o = {};
        	o.scenario = oScenario();
            o.oFilter = oFilter();

        o.init = function() {
            // Generate Object-Structure
            this.rule = oRule();
            	o.scenario.rules.push(this.rule);
            this.filter = oFilter();
            	this.rule.filterRef.push(this.filter);
            // Declare Scenario Info
            this.parent = $("[node='scenario-create-panel']");
            this.saveChanges = this.parent.find("[btn='eventSaveRuleFilters']");

            this.scenarioName = this.parent.find('input.scenario-name-new');
            this.scenario.scenarioName = this.scenarioName.val();
            this.scenarioDesc = this.parent.find('input.scenario-desc-new');
            this.scenario.scenarioDesc = this.scenarioDesc.val();
            this.scenario.author = "Xi, Jie";
            this.scenario.lastEditUser = "Xi, Jie";
            this.scenario.lastUpdateTime.$date = new Date().valueOf();

            // Declare Rule Info
            this.ruleRole = this.parent.find("[name='scenario-create-rule']");
                this.parent.find("[name='scenario-create-rule']:eq(0)").trigger('click');
            this.ruleRoleChecked = this.parent.find("[name='scenario-create-rule']:checked").val();

            this.ruleName = this.parent.find('input.new-rule-name');
            this.ruleNameSearch = this.parent.find('input#scenario-search-rule');
            //
            this.rule.ruleName = this.ruleName.val();
            this.ruleCategory = this.parent.find('select.create-rule-category');

            this.rule.ruleCategory.display = this.ruleCategory.find("option:selected").text();
            this.rule.ruleCategory.value = this.ruleCategory.find("option:selected").val();
            this.ruleType = this.parent.find('select.create-rule-type');

            this.rule.ruleType.display = this.ruleType.find("option:selected").text();
            this.rule.ruleType.value = this.ruleType.find("option:selected").val();
            this.ruleAction = this.parent.find('select.create-rule-action');

            this.rule.action.display = this.ruleAction.find("option:selected").text();
            this.rule.action.value = this.ruleAction.find("option:selected").val();

            // Declare Filter Info
            this.filterRole = this.parent.find("[name='scenario-create-filter']:checked").val();
            this.filterName = this.parent.find('input.new-filter-name');
            // 
            this.filter.filterName = this.filterName.val();
            this.filterList = this.parent.find('table.b-matrix__table');
            //
            this.filter.lastUpdateTime.$date = new Date().valueOf();
            this.filter.author = "Xi, Jie";
            this.filter.lastEditUser = "Xi, Jie";


            this.binding();
            this.render();
        };

        o.binding = function() {

            this.scenarioName.on('keyup paste blur', o.scenarioNameChange);

            this.scenarioDesc.on('keyup paste blur', o.scenarioDescChange);

            this.ruleRole.on('change', o.ruleRoleChange);

            if (this.ruleRoleChecked === 'create') {
                o.ruleName.on('keyup paste blur', o.ruleNameChange);
                o.ruleCategory.on('changed.bs.select', o.ruleCategoryChange);
                o.ruleType.on('changed.bs.select', o.ruleTypeChange);
                o.ruleAction.on('changed.bs.select', o.ruleActionChange);
            }

            if (this.filterRole === "create") {
                this.filterName.on('keyup paste blur', o.filterNameChange);
                this.filterList.on('paste', o.filterListChange);
            } else {
                // to be continued ...
            }

            this.saveChanges.on('click', function() {
            	swal({ 
            		title: "Save this Rule & Filters?", 
            		text: "Continue to create a new Rule & Filters?", 
            		type: "success", 
            		showCancelButton: true, 
            		confirmButtonColor: "#DD6B55", 
            		confirmButtonText: "Create", 
            		cancelButtonText: "Cancel", 
            		closeOnConfirm: false, 
            		closeOnCancel: false 
            	}, function(isConfirm){ 
            		if (isConfirm) { 
            			swal("","Your current settings will be saved!");

            			$("div[data-slide='2']").find('div.template-rule-content').empty()
                            .append(template.rule.content.cloneNode(true))
                            .append(template.filter.content.cloneNode(true));

            			o.init();

                        $('.prev-btn').trigger('click');
            		} else { 
            			swal("Cancelled", "Your current settings will be saved!", "success"); 
            		} 
            	});
            });
            this.filterList.trigger('paste');
        };

        o.scenarioNameChange = function() {
            o.scenario.scenarioName = $(this).val();
            o.scenario.lastUpdateTime.$date = new Date().valueOf();
            o.scenarioInstance.refresh();
        };

        o.scenarioDescChange = function() {
            o.scenario.scenarioDesc = $(this).val();
            o.scenario.lastUpdateTime.$date = new Date().valueOf();
            o.scenarioInstance.refresh();
        };

        o.ruleRoleChange = function() {
            if ($(this).val() === 'create') {
                if (o.ruleName.val() !== "") {
                    o.ruleName.trigger('paste');
                    o.scenario.rules[0].filterRef.push(o.filter);
                } else {
                    o.ruleName.on('keyup paste blur', o.ruleNameChange);
                    o.ruleCategory.on('changed.bs.select', o.ruleCategoryChange);
                    o.ruleType.on('changed.bs.select', o.ruleTypeChange);
                    o.ruleAction.on('changed.bs.select', o.ruleActionChange);
                }
            } else if ($(this).val() === 'search') {
                o.ruleNameSearch.on('keyup paste blur', o.ruleNameChange);
                o.ruleCategoryUpdate();
                if (o.ruleNameSearch.val() !== "") {
                    o.ruleNameSearch.trigger('paste');
                }  
                o.scenario.rules[0].filterRef = [o.oFilter];
            }
        };

        o.ruleNameChange = function() {
            o.rule.ruleName = $(this).val();
            o.scenarioInstance.refresh();
        };

        o.ruleCategoryChange = function() {
            o.rule.ruleCategory.display = $(this).find("option:selected").text();
            o.rule.ruleCategory.value = $(this).find("option:selected").val();
            o.scenarioInstance.refresh();
        };

        o.ruleCategoryUpdate = function() {
            // Clear Rule Name
            o.scenario.rules[0].ruleName = "";
            // Clear Rule Category
            o.scenario.rules[0].ruleCategory = {
                display: "",
                code: ""
            };
            // Clear Rule Type
            o.scenario.rules[0].ruleType = {
                display: "",
                code: ""
            };
            // Clear Rule Action
            o.scenario.rules[0].action = {
                display: "",
                code: ""
            };
            // Refresh Instance
            o.scenarioInstance.refresh();
        };

        o.ruleTypeChange = function() {
            o.rule.ruleType.display = $(this).find("option:selected").text();
            o.rule.ruleType.value = $(this).find("option:selected").val();
            o.scenarioInstance.refresh();
        };

        o.ruleActionChange = function() {
            o.rule.action.display = $(this).find("option:selected").text();
            o.rule.action.value = $(this).find("option:selected").val();
            o.scenarioInstance.refresh();
        };

        o.filterNameChange = function() {
            o.filter.filterName = $(this).val();
            o.scenarioInstance.refresh();
        };

        o.filterListChange = function() {
            o.filter.objects = $(this).data('filters');

            if (o.hasOwnProperty('scenarioInstance')) {
                o.scenarioInstance.refresh();
            }
        };

        o.filterListUpdate = function() {
            var $reverseData = o.filterList.data('reverseData')[0];

            o.parent.find('.filter-create-matrix').empty().append(template.filterMatrix.content.cloneNode(true));
            o.filterList = o.parent.find('table.b-matrix__table');
      
            o.filter = $reverseData;
            o.filter.lastEditUser = "Xi, Jie";
            o.filter.lastUpdateTime.$date = new Date().valueOf();
            o.filterName.val($reverseData.filterName).on('keyup paste blur', o.filterNameChange).trigger('paste');
            o.filter.filterName = o.filterName;
            o.filterList.data('filters', o.filter.objects);
            o.filterlistRepaint();
        };

        o.filterlistRepaint = function() {
            var $table = o.filterList,
                $btn = $table.closest('.filter-create-matrix').find("[btn='eventAddFilter']");

            $.each(o.filter.objects, function(i,v) {
                $table.find('tr:last').find('select.select-type').selectpicker('val', v.object.code).trigger('changed.bs.select');
                $table.find('tr:last').find('select.select-condition').selectpicker('val', v.condition.code).trigger('changed.bs.select');
                $table.find('tr:last').find('input.condition_value').val(v.value).trigger('paste');

                if (i+1 < o.filter.objects.length) {
                    $btn.trigger('click');
                }
            });

            o.filterList.on('paste', o.filterListChange);
        }

        o.render = function() {
            o.scenarioInstance = $('.matrix-result-preview').dxDataGrid({
                dataSource: [o.scenario],
                allowColumnReordering: true,
                sorting: {
                    mode: 'multiple'
                },
                showRowLines: true,
                columns: [{
                    dataField: 'scenarioName',
                    caption: "Scenario Name",
                    allowResizing: true
                }, {
                    dataField: 'author',
                    caption: "Author",
                    allowResizing: true,
                    width: 150
                }, {
                    dataField: 'last Update Time',
                    allowResizing: true,
                    allowGrouping: false,
                    dataType: 'date',
                    width: 200,
                    cellTemplate: function(container, options) {
                        var oDate = new Date(Number(options.data.lastUpdateTime.$date));
                        container.append((oDate.getMonth() + 1) + "/" + oDate.getDate() + '/' + oDate.getFullYear());
                    }
                }, {
                    dataField: 'lastEditUser',
                    caption: "Last Editer",
                    allowResizing: true,
                    width: 200
                }, {
                	dataField: 'scenarioDesc',
                	caption: 'Description',
                	allowResizing: true
                }],
                // Master-Detail FOR Rules
                masterDetail: {
                    enabled: true,
                    autoExpandAll: true,
                    template: function(container, options) {
                    	var rulesObj = options.data.rules;
                        $('<div>', {
                            'class': 'matrix-result-rule'
                        }).dxDataGrid({
                        	dataSource: rulesObj,
                        	columnAutoWidth: true,
                        	showRowLines: true,
                        	columns: [{
			                    dataField: "ruleName",
			                    caption: 'Rule Name',
			                    allowResizing: true
			                }, {
			                    dataField: "ruleCategory.display",
			                    caption: "Rule Category",
			                    allowResizing: true
			                }, {
			                    dataField: "ruleType.display",
			                    caption: "Rule Type",
			                    allowResizing: true
			                }, {
			                    dataField: "action.display",
			                    caption: "Action",
			                    allowResizing: true
			                }, {
			                    caption: "Active",
			                    dataType: "boolean",
			                    width: 80,
			                    calculateCellValue: function(rowData) {
			                        return rowData.active == true;
			                    }
			                }],
			                // Master-Detail for Filter
			                masterDetail: {
			                	enabled: true,
			                	autoExpandAll: true,
			                	template: function(container, options) {
			                		var filterObj = options.data.filterRef;
			                		$("<div>").dxDataGrid({
			                			dataSource: filterObj,
			                			showRowLines: true,
						                allowColumnReordering: true,
						                wordWrapEnabled: true,
						                columns: [{
						                    dataField: "filterName",
						                    caption: "Filter Name",
                                            allowResizing: true
						                }, {
						                    dataField: "author",
						                    caption: "Author",
                                            allowResizing: true
						                }, {
						                    dataField: "lastEditUser",
						                    caption: "Last Editor",
                                            allowResizing: true
						                }, {
						                    dataField: "lastUpdateTime",
						                    caption: "Last Update Time",
                                            allowResizing: true,
						                    dateType: "date",
						                    cellTemplate: function(container, options) {
						                        var oDate = new Date(Number(options.data.lastUpdateTime.$date));
						                        container.append((oDate.getMonth() + 1) + "/" + oDate.getDate() + '/' + oDate.getFullYear());
						                    }
						                }],
						                masterDetail: {
						                    enabled: true,
						                    autoExpandAll: true,
						                    template: function(container, options) {
						                        var conditionObj = options.data.objects;
						                        $('<div>').dxDataGrid({
						                            dataSource: conditionObj,
						                            columnAutoWidth: true,
						                            showRowLines: true,
						                            columns: [{
						                                caption: "Condition Name",
						                                dataField: "object.display",
						                                alignment: "left"
						                            }, {
						                                dataField: "condition.code",
						                                alignment: "center",
						                                caption: "Condition",
						                                customizeText: function(cellInfo) {
						                                    switch (cellInfo.value) {
						                                        case "EQ":
						                                            return "=";
						                                            break;
						                                        case "GE":
						                                            return "≥";
						                                            break;
						                                        case "LE":
						                                            return "≤";
						                                            break;
						                                        case "LT":
						                                            return "<";
						                                            break;
						                                        case "GT":
						                                            return ">";
						                                            break;
						                                    }
						                                }
						                            }, {
						                                dataField: "value",
						                                alignment: "left",
						                                caption: "Value"
						                            }]
						                        }).appendTo(container);
						                    }
						                }
			                		}).appendTo(container);
			                	}
			                }
                        }).appendTo(container);
                    }
                }
            }).dxDataGrid('instance');
        };

        return o;
    })();
    </script>
</template>
<script>
if (!window.template.hasOwnProperty('result')) {
    var $template = document.querySelector('#template-matrix-result').import;
    window.template.result = $template.querySelector('template').cloneNode(true);
}
</script>
