<template>
	<div class="col-md-12">
		<div class='matrix-result-preview'></div>
	</div>
	<script async>
		var oFilter = function() {
			return {
				_id: {
		            "$oid": ""
		        },
		        author: "",
		        filterName: "",
		        guid: "",
		        lastEditUser: "",
		        lastUpdateTime: {
		            $date: ""
		        },
		        objects: []
			}
		};

		var oRule = function() {
			return {
				"active": true,
                "filterRef": "",
                "ruleName": "",
                "ruleCategory": {
                    "display": "",
                    "value": ""
                },
                "ruleType": {
                    "display": "",
                    "value": ""
                },
                "action": {
                    "display": "",
                    "value": ""
                },
                "defaultCriticalRatio": "",
                "minTargetInv": "",
                "criticalRatio": "",
                "horizonAdjust": ""
			}
		};

		var oScenario = function() {
			return {
				"_id": {
		            "$oid": ""
		        },
		        "guid": "",
		        "lastEditUser": "",
		        "lastUpdateTime": {
		            "$date": ""
		        },
		        "author": "",
		        "scenarioName": "",
		        "scenarioDesc": "",
		        "production": false,
		        "rules": []
			}
		};

		var MatrixEditor = (function() {
			var o = {};

			o.init = function() {
				// Generate Object-Structure
				this.scenario = oScenario();
				this.rule = oRule();
				this.filter = oFilter();
				// Declare Scenario Info
				this.parent = $("[node='scenario-create-panel']");
				this.saveRules = this.parent.find("[btn='eventSaveRuleFilters']");

				this.scenarioName = this.parent.find('input.scenario-name-new');
					this.scenario.scenarioName = this.scenarioName.val();
				this.scenarioDesc = this.parent.find('input.scenario-desc-new');
					this.scenario.scenarioDesc = this.scenarioDesc.val();
					this.scenario.author = "Xi, Jie";
					this.scenario.lastEditUser = "Xi, Jie";
					this.scenario.lastUpdateTime.$date = new Date().valueOf();

				// Declare Rule Info
				this.ruleRole = this.parent.find("[name='scenario-create-rule']:checked").val();
				this.ruleName = this.parent.find('input.new-rule-name');
					//
					this.rule.ruleName = this.ruleName.val();
				this.ruleCategory = this.parent.find('select.create-rule-category');

					this.rule.ruleCategory.display = this.ruleCategory.find("option:selected").text();
					this.rule.ruleCategory.value = this.ruleCategory.find("option:selected").val();
				this.ruleType = this.parent.find('select.create-rule-type');

					this.rule.ruleType.display = this.ruleType.find("option:selected").text();
					this.rule.ruleType.value = this.ruleType.find("option:selected").val();
				this.ruleAction = this.parent.find('select.create-rule-action');

					this.rule.action.display = this.ruleAction.find("option:selected").text();
					this.rule.action.value = this.ruleAction.find("option:selected").val();

				// Declare Filter Info
				this.filterRole = this.parent.find("[name='scenario-create-filter']:checked").val();
				this.filterName = this.parent.find('input.new-filter-name');
					// 
					this.filter.filterName = this.filterName.val();
				this.filterList = this.parent.find('table.b-matrix__table');
					//
					this.filter.lastUpdateTime.$date = new Date().valueOf();
					this.filter.author = "Xi, Jie";
					this.filter.lastEditUser = "Xi, Jie";
					

				this.binding();
				this.render();
			};

			o.binding = function() {

				this.scenarioName.on('keyup paste blur', o.scenarioNameChange);

				this.scenarioDesc.on('keyup paste blur', o.scenarioDescChange);

				if (this.ruleRole === "create") {
					this.ruleName.on('keyup paste blur', o.ruleNameChange);
					this.ruleCategory.on('changed.bs.select', o.ruleCategoryChange);
					this.ruleType.on('changed.bs.select', o.ruleTypeChange);
					this.ruleAction.on('changed.bs.select', o.ruleActionChange);
				} else {
					// to be continued ...
				}

				if (this.filterRole === "create") {
					this.filterName.on('keyup paste blur', o.filterNameChange);
					this.filterList.on('paste', o.filterListChange);
				} else {
					// to be continued ...
				}

				// this.saveRules.on('click', function() {
					
				// });
				this.filterList.trigger('paste');
			};

			o.scenarioNameChange = function() {
				o.scenario.scenarioName = $(this).val();
				o.scenario.lastUpdateTime.$date = new Date().valueOf();
				o.scenarioInstance.refresh();
			};

			o.scenarioDescChange = function() {
				o.scenario.scenarioDesc = $(this).val();
				o.scenario.lastUpdateTime.$date = new Date().valueOf();
				o.scenarioInstance.refresh();
			};

			o.ruleNameChange = function() {
				o.rule.ruleName = $(this).val();
				o.ruleInstance.refresh();
			};

			o.ruleCategoryChange = function() {
				o.rule.ruleCategory.display = $(this).find("option:selected").text();
				o.rule.ruleCategory.value = $(this).find("option:selected").val();
				o.ruleInstance.refresh();
			};

			o.ruleTypeChange = function() {
				o.rule.ruleType.display = $(this).find("option:selected").text();
				o.rule.ruleType.value = $(this).find("option:selected").val();
				o.ruleInstance.refresh();
			};

			o.ruleActionChange = function() {
				o.rule.action.display = $(this).find("option:selected").text();
				o.rule.action.value = $(this).find("option:selected").val();
				o.ruleInstance.refresh();
			};

			o.filterNameChange = function() {
				o.filter.filterName = $(this).val();
				o.filterInstance.refresh();
			};

			o.filterListChange = function() {
				o.filter.objects = $(this).data('filters');
				o.filters = $(this).data('filters');

				$.each(o.filters, function(i,v) {
					v.filterName = o.filter.filterName;
					v.author = o.filter.author;
                    v.lastEditUser = o.filter.lastEditUser;
                    v.lastUpdateTime = o.filter.lastUpdateTime.$date; 
				});

				if (o.hasOwnProperty('filterInstance')) {
					o.filterInstance.option({
						dataSource: o.filters
					});
					o.filterInstance.refresh();
				}
			};

			o.render = function() {
				o.scenarioInstance = $('.matrix-result-preview').dxDataGrid({
			        dataSource: [o.scenario],
			        filterRow: {
			            visible: true,
			            applyFilter: "auto"
			        },
			        allowColumnReordering: true,
			        sorting: { 
			            mode: 'multiple' 
			        },
			        showRowLines: true,
			        columns: [{
			            dataField: 'scenarioName',
			            caption: "Scenario Name",
			            allowResizing: true
			        }, {
			            dataField: 'author',
			            caption: "Author",
			            allowResizing: true,
			            width: 150
			        }, {
			            dataField: 'last Update Time',
			            allowResizing: true,
			            allowGrouping: false,
			            dataType: 'date',
			            width: 200,
			            cellTemplate: function(container, options){
			                var oDate = new Date(Number(options.data.lastUpdateTime.$date));
			                container.append((oDate.getMonth() + 1) +"/"+oDate.getDate()+ '/' + oDate.getFullYear());
			            }
			        }, {
			            dataField: 'lastEditUser',
			            caption: "Last Editer",
			            allowResizing: true,
			            width: 200
			        }],
			        masterDetail: {
			            enabled: true,
			            template: function(container) {
			            	$('<div>', {'class' : 'matrix-result-rule'}).appendTo(container);
			                o.renderRule();
			            }
			        }
			    }).dxDataGrid('instance');
			};

			o.renderRule = function() {
				o.ruleInstance = $('.matrix-result-rule').dxDataGrid({
	                dataSource: [o.rule],
	                columnAutoWidth: true,
	                showRowLines: true,
	                allowColumnReordering: true,
	                columnAutoWidth: true,
	                filterRow: {
	                    visible: true,
	                    applyFilter: "auto"
	                },
	                columns: [{
	                    dataField: "ruleName",
	                    caption: 'Rule Name',
	                    allowResizing: true
	                }, {
	                    dataField: "ruleCategory.display",
	                    caption: "Rule Category",
	                    allowResizing: true
	                }, {
	                    dataField: "ruleType.display",
	                    caption: "Rule Type",
	                    allowResizing: true
	                }, {
	                    dataField: "action.display",
	                    caption: "Action",
	                    allowResizing: true
	                }, {
	                    caption: "Active",
	                    dataType: "boolean",
	                    width: 80,
	                    calculateCellValue: function(rowData) {
	                        return rowData.active == true;
	                    }
	                }],masterDetail: {
	                    enabled: true,
	                    template: function(container) {
	                        $('<div>', {'class' : 'matrix-result-filter'}).appendTo(container);
	                        o.renderFilter();
	                    }
	                }
	            }).dxDataGrid('instance');
			};

			o.renderFilter = function() {
				o.filterInstance = $('.matrix-result-filter').dxDataGrid({
		            dataSource : o.filters,
		            showRowLines: true,
		            allowColumnReordering: true,
		            wordWrapEnabled: true,
		            columns: [{
		                    dataField: "filterName",
		                    caption: "Filter Name",
		                    groupIndex: 0
		                }, {
		                    dataField: "author",
		                    caption: "Author",
		                    visible: false
		                }, {
		                    dataField: "lastEditUser",
		                    caption: "Last Editor",
		                    visible: false
		                }, {
		                    dataField: "lastUpdateTime",
		                    caption: "Last Update Time",
		                    dateType: "date",
		                    visible: false,
		                    cellTemplate: function(container, options){
		                        var oDate = new Date(Number(options.data.lastUpdateTime));
		                        container.append((oDate.getMonth() + 1) +"/"+oDate.getDate()+ '/' + oDate.getFullYear());
		                    }
		                }, {
		                    caption: "Condition Name",
		                    dataField: "object.display",
		                    alignment: "left"
		                }, {
		                    dataField: "condition.code",
		                    alignment: "center",
		                    caption: "Condition",
		                    customizeText: function(cellInfo) {
		                        switch (cellInfo.value) {
		                            case "EQ":
		                                return "=";
		                                break;
		                            case "GE":
		                                return "≥";
		                                break;
		                            case "LE":
		                                return "≤";
		                                break;
		                            case "LT":
		                                return "<";
		                                break;
		                            case "GT": 
		                                return ">";
		                                break;
		                        }
		                    }
		                }, {
		                    dataField: "value",
		                    alignment: "left",
		                    caption: "Value"
		                }
		            ],
		            sortByGroupSummaryInfo: [{
		                summaryItem: "count"
		            }],
		            summary: {
		                groupItems: [{
		                    column: "object.display",
		                    summaryType: "count",
		                    displayFormat: "{0} conditions",
		                }]
		            },
		            // onInitNewRow: function(e){
		            // 	e.data = o.filters.pop();
		            // }
		        }).dxDataGrid('instance');
			};

			return o;
		})();

		
	</script>
</template>
<script>
	if (!window.template.hasOwnProperty('result')) {
        var $template = document.querySelector('#template-matrix-result').import;
        window.template.result = $template.querySelector('template').cloneNode(true);
    }
</script>