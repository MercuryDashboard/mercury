<template>
	<div class="col-md-12">
		<div class='matrix-result-preview'></div>
	</div>
	<script>

		var oFilterObject = function() {
			return {
				"condition": {
                    "code": "",
                    "display": ""
                },
                "object": {
                    "code": "",
                    "display": ""
                },
                "value": ""
			}
		};

		var oFilter = function() {
			return {
				_id: {
		            "$oid": ""
		        },
		        author: "",
		        filterName: "",
		        guid: "",
		        lastEditUser: "",
		        lastUpdateTime: {
		            $date: ""
		        },
		        objects: []
			}
		};

		var oRule = function() {
			return {
				"active": true,
                "filterRef": "",
                "ruleName": "",
                "ruleCategory": {
                    "display": "",
                    "value": ""
                },
                "ruleType": {
                    "display": "",
                    "value": ""
                },
                "action": {
                    "display": "",
                    "value": ""
                },
                "defaultCriticalRatio": "",
                "minTargetInv": "",
                "criticalRatio": "",
                "horizonAdjust": ""
			}
		};

		var oScenario = function() {
			return {
				"_id": {
		            "$oid": ""
		        },
		        "guid": "",
		        "lastEditUser": "",
		        "lastUpdateTime": {
		            "$date": ""
		        },
		        "author": "",
		        "scenarioName": "",
		        "scenarioDesc": "",
		        "production": false,
		        "rules": []
			}
		};

		var MatrixEditor = (function() {
			var o = {};

			o.init = function() {
				// Generate Object-Structure
				this.scenario = oScenario();
				this.rule = oRule();
				this.filter = oFilter();
				// Declare Scenario Info
				this.parent = $(".mercury-slide-panel:not('.mercury-slide-panel-closed')");
				this.saveRules = this.parent.find("[btn='eventSaveRuleFilters']");
				console.log(this.saveRules);

				this.scenarioName = this.parent.find('input.scenario-name-new');
					this.scenario.scenarioName = this.scenarioName.val();
				this.scenarioDesc = this.parent.find('input.scenario-desc-new');
					this.scenario.scenarioDesc = this.scenarioDesc.val();
					this.scenario.author = "Xi, Jie";
					this.scenario.lastEditUser = "Xi, Jie";
					this.scenario.lastUpdateTime.$date = new Date().valueOf();

				// Declare Rule Info
				this.ruleRole = this.parent.find("[name='scenario-create-rule']:checked").val();
				this.ruleName = this.parent.find('input.new-rule-name');
					//
					this.rule.ruleName = this.ruleName.val();
				this.ruleCategory = this.parent.find('select.create-rule-category');

					this.rule.ruleCategory.display = this.ruleCategory.find("option:selected").text();
					this.rule.ruleCategory.value = this.ruleCategory.find("option:selected").val();
				this.ruleType = this.parent.find('select.create-rule-type');

					this.rule.ruleType.display = this.ruleType.find("option:selected").text();
					this.rule.ruleType.value = this.ruleType.find("option:selected").val();
				this.ruleAction = this.parent.find('select.create-rule-action');

					this.rule.action.display = this.ruleAction.find("option:selected").text();
					this.rule.action.value = this.ruleAction.find("option:selected").val();

				// Declare Filter Info
				this.filterRole = this.parent.find("[name='scenario-create-filter']:checked").val();
				this.filterName = this.parent.find('input.new-filter-name');
				this.filterList = this.parent.find('table.b-matrix__table');
					// 
					this.filter.filterName = this.filterName.val();

				this.binding();
				this.render();
			};

			o.binding = function() {

				this.scenarioName.on('keyup paste blur', o.scenarioNameChange);

				this.scenarioDesc.on('keyup paste blur', o.scenarioDescChange);

				if (this.ruleRole === "create") {
					this.ruleName.on('keyup paste blur', o.ruleNameChange);
					this.ruleCategory.on('changed.bs.select', o.ruleCategoryChange);
					this.ruleType.on('changed.bs.select', o.ruleTypeChange);
					this.ruleAction.on('changed.bs.select', o.ruleActionChange);
				} else {
					// to be continued ...
				}

				if (this.filterRole === "create") {
					this.filterName.on('keyup paste blur', o.filterNameChange);
					this.filterList.on('paste', o.filterListChange);

				} else {
					// to be continued ...
				}

				this.saveRules.on('click', function(e) {
					e.stopPropagation();
					console.log(e);
				});
			};

			o.scenarioNameChange = function() {
				o.scenario.scenarioName = $(this).val();
				o.scenario.lastUpdateTime.$date = new Date().valueOf();
				o.scenarioInstance.refresh();
			};

			o.scenarioDescChange = function() {
				o.scenario.scenarioDesc = $(this).val();
				o.scenario.lastUpdateTime.$date = new Date().valueOf();
				o.scenarioInstance.refresh();
			};

			o.ruleNameChange = function() {
				o.rule.ruleName = $(this).val();
			};

			o.ruleCategoryChange = function() {
				o.rule.ruleCategory.display = $(this).find("option:selected").text();
				o.rule.ruleCategory.value = $(this).find("option:selected").val();
			};

			o.ruleTypeChange = function() {
				o.rule.ruleType.display = $(this).find("option:selected").text();
				o.rule.ruleType.value = $(this).find("option:selected").val();
			};

			o.ruleActionChange = function() {
				o.rule.action.display = $(this).find("option:selected").text();
				o.rule.action.value = $(this).find("option:selected").val();
			};

			o.filterNameChange = function() {
				o.filter.filterName = $(this).val();
			};

			o.filterListChange = function() {
				o.filter.objects = $(this).data('filters');
			};

			o.render = function() {
				o.scenarioInstance = $('.matrix-result-preview').dxDataGrid({
			        dataSource: [o.scenario],
			        filterRow: {
			            visible: true,
			            applyFilter: "auto"
			        },
			        allowColumnReordering: true,
			        sorting: { 
			            mode: 'multiple' 
			        },
			        showRowLines: true,
			        columns: [{
			            dataField: 'scenarioName',
			            caption: "Scenario Name",
			            allowResizing: true
			        }, {
			            dataField: 'author',
			            caption: "Author",
			            allowResizing: true,
			            width: 150
			        }, {
			            dataField: 'last Update Time',
			            allowResizing: true,
			            allowGrouping: false,
			            dataType: 'date',
			            width: 200,
			            cellTemplate: function(container, options){
			                var oDate = new Date(Number(options.data.lastUpdateTime.$date));
			                container.append((oDate.getMonth() + 1) +"/"+oDate.getDate()+ '/' + oDate.getFullYear());
			            }
			        }, {
			            dataField: 'lastEditUser',
			            caption: "Last Editer",
			            allowResizing: true,
			            width: 200
			        }],
			        masterDetail: {
			            enabled: true,
			            template: function(container, options) {
			                //masterDetailScenario(container, options);
			            }
			        }
			    }).dxDataGrid('instance');
			};

			o.renderRule = function() {

			};

			return o;
		})();

		
	</script>
</template>
<script>
	if (!window.template.hasOwnProperty('result')) {
        var $template = document.querySelector('#template-matrix-result').import;
        window.template.result = $template.querySelector('template').cloneNode(true);
    }
</script>